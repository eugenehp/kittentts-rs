# KittenTTS iOS

A SwiftUI application that runs the KittenTTS text-to-speech engine entirely
on-device using the Rust library via a C FFI bridging header.

![ios](./ios.png)

---

## Prerequisites

| Tool | Version | How to get |
|------|---------|------------|
| Xcode | 15+ | Mac App Store |
| Rust | stable | `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \| sh` |
| iOS Rust targets | — | `rustup target add aarch64-apple-ios aarch64-apple-ios-sim` |
| CMake | 3.22+ | `brew install cmake` |
| Ninja | any | `brew install ninja` |
| libtool | any | `xcode-select --install` |

---

## Quick start

```bash
# From the repository root:
bash ios/build_rust_ios.sh
```

Then open the project in Xcode:

```bash
open ios/KittenTTSApp/KittenTTSApp.xcodeproj
```

Set your **development team** in *Signing & Capabilities* and press **Run**.

---

## What the build script does

| Step | Action |
|------|--------|
| 1 | Clones and cross-compiles **espeak-ng 1.52.0** for `iphoneos` (device) and `iphonesimulator` → two `libespeak-ng.a` static libraries |
| 2 | Compiles espeak-ng phoneme tables with a **native macOS build** (device/simulator binaries cannot run on the build host) → `ios/espeak-ng-data/` |
| 3 | Cross-compiles **kittentts-rs** for `aarch64-apple-ios` and `aarch64-apple-ios-sim`; ort-sys automatically downloads and caches the ORT static library for each slice |
| 4 | Locates the ORT `.a` files downloaded by ort-sys into `~/Library/Caches/ort.pyke.io/` |
| 5 | Merges Rust + ORT + espeak-ng into a single fat `.a` per slice using `libtool` |
| 6 | Packages both slices into **`ios/KittenTTS.xcframework`** using `xcodebuild -create-xcframework` |
| 7 | Downloads model files from HuggingFace into `ios/KittenTTSApp/KittenTTSApp/Models/` |

The script is **incremental**: espeak-ng and the cargo build are stamp-file-guarded and skipped on re-runs if already complete.

---

## Xcode setup (after first build)

Two resources are generated by the build script and must be present in the
Xcode project before running:

### 1. KittenTTS.xcframework
Already referenced in `project.pbxproj` — nothing extra needed after the first
`build_rust_ios.sh` run, as long as `ios/KittenTTS.xcframework/` exists.

If you regenerate the framework (e.g. after a Rust change), Xcode picks up
the new `.a` files automatically on the next build.

### 2. espeak-ng-data folder reference
`espeak-ng-data/` must be added to the Xcode target as a **folder reference**
(blue folder icon) so the entire directory tree is copied into the app bundle.

If it is missing:
1. Drag `ios/espeak-ng-data/` into the Xcode project navigator.
2. In the dialog, select **"Create folder references"** (not groups).
3. Tick the app target in "Add to targets".

At runtime, `TTSEngine.swift` locates the directory via:
```swift
Bundle.main.resourceURL?.appendingPathComponent("espeak-ng-data")
```

---

## Architecture

```
Swift (SwiftUI)
      │
      │  C FFI via Objective-C bridging header
      ▼
KittenTTS-Bridging-Header.h  ──►  kittentts.h  (C API)
                                        │
                                        ▼
                                KittenTTS.xcframework
                                 (single static library per slice)
                                        │
                                        ├── Rust (kittentts-rs)
                                        │     ├── model.rs      (ORT inference)
                                        │     ├── phonemize.rs  (espeak-ng)
                                        │     ├── preprocess.rs
                                        │     └── tokenize.rs
                                        │
                                        ├── libonnxruntime.a   (statically merged)
                                        └── libespeak-ng.a     (statically merged)
```

**Everything is statically linked** — the xcframework is a single self-contained
`.a` per platform slice with no dynamic dependencies.  This avoids the C++ ABI
issues that affect the Android build (iOS uses Apple's Clang + libc++ throughout).

### Data flow

```
User text
   │
   ▼  TextPreprocessor — numbers/punctuation → words
   │
   ▼  espeak-ng C library → IPA phoneme string
   │
   ▼  ipa_to_ids() → token ID sequence
   │
   ▼  ONNX Runtime session
      inputs:  input_ids  [1, seq_len]  i64
               style      [1, 256]      f32
               speed      [1]           f32
      output:  waveform   [T]           f32
   │
   ▼  write_wav() → 16-bit PCM WAV, mono, 24 kHz
   │
   ▼  AVAudioFile + AVAudioPlayerNode + AVAudioEngine
   │
   ▼  speaker
```

### Audio format

Output is **16-bit signed PCM, mono, 24 kHz**.  `AVAudioFile(forReading:)`
detects the format automatically from the WAV header and configures the
`AVAudioPlayerNode` connection accordingly.

---

## Runtime behaviour

### Model files
`TTSEngine` looks for model files in `Application Support/KittenTTS/`.  On
first launch it checks whether each file exists; if not, it downloads from
HuggingFace with a progress indicator.  `build_rust_ios.sh` pre-populates
`KittenTTSApp/Models/` so they are **bundled in the app** and copied to
Application Support on first launch — no network access needed.

Remove `KittenTTSApp/Models/` from the Xcode project to use the
download-on-demand flow instead.

### espeak-ng data
Located via `Bundle.main.resourceURL` at runtime.  The `phontab` file is
checked on startup; a clear error message is shown if it is missing.

### Audio session
`AVAudioSession` is set to `.playback` mode before each synthesis so that audio
plays through the speaker even when the device is on silent / ringer switch off.

---

## Project structure

```
ios/
├── build_rust_ios.sh                  ← run this first
├── ios_endian_compat.h                Endian shim (iOS lacks <endian.h>)
├── README.md
├── KittenTTS.xcframework/             ← generated by build script
│   ├── Info.plist
│   ├── ios-arm64/
│   │   ├── Headers/kittentts.h
│   │   └── libKittenTTS-device.a
│   └── ios-arm64-simulator/
│       ├── Headers/kittentts.h
│       └── libKittenTTS-simulator.a
├── espeak-ng-data/                    ← generated by build script
│   ├── phontab
│   ├── phondata
│   ├── phonindex
│   ├── intonations
│   ├── lang/
│   └── <language>_dict …
└── KittenTTSApp/
    ├── KittenTTSApp.xcodeproj/
    │   └── project.pbxproj
    └── KittenTTSApp/
        ├── KittenTTSApp.swift          @main entry point
        ├── ContentView.swift           Root view (download / load / TTS)
        ├── TTSEngine.swift             ObservableObject ViewModel
        ├── AudioPlayerBar.swift        Bottom player bar with waveform
        ├── KittenTTS-Bridging-Header.h Exposes kittentts.h to Swift
        ├── Info.plist
        ├── Assets.xcassets/
        └── Models/                     ← generated by build script (~40 MB)
            ├── kitten_tts_mini_v0_8.onnx
            ├── voices.npz
            └── config.json
```

---

## Troubleshooting

| Symptom | Likely cause | Fix |
|---------|--------------|-----|
| `ld: library not found for -lKittenTTS` | `KittenTTS.xcframework` missing | Run `build_rust_ios.sh` |
| `kittentts_model_load` returns nil | ORT or espeak-ng init failed | Check Xcode console; verify `espeak-ng-data` is in the bundle as a folder reference |
| "espeak-ng-data not found in the app bundle" | Folder added as a group, not a folder reference | Remove from Xcode, re-add with *"Create folder references"* (blue icon) |
| "phontab is missing" | Stale or incomplete `espeak-ng-data/` | Re-run `build_rust_ios.sh` and re-add the folder |
| No audio on device | Silent mode / AVAudioSession not active | Ensure `UIBackgroundModes` includes `audio` in Info.plist |
| Simulator build fails | Simulator slice missing from xcframework | Re-run `build_rust_ios.sh`; the script builds both `aarch64-apple-ios` and `aarch64-apple-ios-sim` |
| ORT not found after cargo build | ort-sys cache path changed | Check `~/Library/Caches/ort.pyke.io/` for `libonnxruntime.a`; update hash constants in `build_rust_ios.sh` if the ort crate version changed |
| Model download times out | Network issue | Retry; or copy files manually into `KittenTTSApp/Models/` |
